<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Worcester Demographic Change</title>

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        html, body {
			height: 100%;
			margin: 10px;
		}

		.leaflet-container {
			height: 400px;
			width: 600px;
			max-width: 100%;
			max-height: 100%;
		}

		h1 {
			text-align: center;
		}

		#map-container {
			width: 100%;
			height: 400px;
			display: flex;
			flex-direction: row;
		}

		#map {
			width: 80%;
			height: 500px;
		}

		.info { 
			padding: 6px 8px; 
			font: 14px/16px Arial, Helvetica, sans-serif; 
			background: white; 
			background: rgba(255,255,255,0.8); 
			box-shadow: 0 0 15px rgba(0,0,0,0.2); 
			border-radius: 5px; 
		} 

		.info h4 { 
			margin: 0 0 5px; 
			color: #777; 
		}
		
		.legend { 
			text-align: left; 
			line-height: 18px; 
			color: #555; 
		} 
		
		.legend i { 
			width: 18px; 
			height: 18px; 
			float: left; 
			margin-right: 8px; 
			opacity: 0.8; 
		}

		#select-map {
			width: 20%;
			padding-bottom: 5px;
			align-items: center;
			display: flex;
			flex-direction: column;
		}

		button.buttons {
			/* --bg: #f2f2f2; */
			background-color: #f2f2f2;
			width: 100%;
			/* min-width: 13.5%; */
			min-height: 50px;
			/* height: var(--button-height); */
			line-height: 1;
			padding: 6px 4px 10px;
		}

		button.buttons.selected {
			/* --bg: #fff; */
			background-color: #fff;
		}

		img.buttons {
			width: 50px; /* 100% */
			height: 50px; /* 100% */
			object-fit:contain
		}

		span.buttons {
			/* position: absolute; */
			display: block;
			/* left: .5em; */
			/* bottom: .4em; */
			font-size: 8px;
			text-wrap: wrap;
			/* filter:drop-shadow(-1px -1px 0px var(--bg)) drop-shadow(1px -1px 0px var(--bg)) */
		}

		/* This is for wider screens (the default is narrow) */
		@media screen and (min-width: 800px) {	
			#map-container {
				display: block;
			}
			
			#map {
				width: 100%;
			}

			#select-map {
				width: 100%;
				display: block;
			}
			
			button.buttons {
				width: 13.8%;
			}
		}

		@media screen and (min-width: 600px) {
			span.buttons {
				font-size: 10px;
			}
		}

		@media screen and (min-width: 1200px) {
			span.buttons {
				font-size: 12px;
			}
		}


    </style>
</head>
<body>
	<h1>Neighborhood Change in Worcester</h1>
	<div id="map-container">
		<div id="select-map">
			<button onclick="updateProperty('PercChangePop')" class="buttons selected" id="PercChangePop">
				<span class="buttons"> Total Population </span>
			</button>
			<button onclick="updateProperty('PercChangeWhitePop')" class="buttons" id="PercChangeWhitePop">
				<!-- <img src="Berry.jpg" loading="lazy" class = "buttons"> -->
				<span class="buttons"> Non-Hispanic White </span>
			</button>
			<button onclick="updateProperty('PercChangeBach')" class="buttons" id="PercChangeBach">
				<span class="buttons"> Education </span>
			</button>
			<button onclick="updateProperty('PercChangeHomeown')" class="buttons" id="PercChangeHomeown">
				<span class="buttons"> Homeownership </span>
			</button>
			<button onclick="updateProperty('PercChangeInc')" class="buttons" id="PercChangeInc">
				<span class="buttons"> Median Income </span>
			</button>
			<button onclick="updateProperty('PercChangeHomeVal')" class="buttons" id="PercChangeHomeVal">
				<span class="buttons"> Median Home Value </span>
			</button>
			<button onclick="updateProperty('PercChangeMedRent')" class="buttons" id="PercChangeMedRent">
				<span class="buttons"> Median Rent </span>
			</button>
		</div>
		<div id="map"></div>
	</div>

	<!-- Gonna test this for now with the Campeche Pop Dens file -->
	<script type="text/javascript" src="WorcesterAllData.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.4.0/easy-button.js"></script>

	<script>
		// Create map
		const map = L.map('map').setView([42.27, -71.8], 11);

		// Base layer
		L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		}).addTo(map)

		// Add attribution CHANGE THIS
		map.attributionControl.addAttribution('Population data &copy; <a href="https://data.census.gov">American Community Survey (ACS)</a>');

		// Add the home button
		L.easyButton('fa-home', function(btn, map) {
                map.setView([42.27, -71.8], 11);
            }).addTo(map);


		// Control that shows Census tract info on hover
		const info = L.control();
	
		// When it is added it does the following
		info.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'info');
			this.update();
			return this._div;
		};

		// Helper function for the update function to get the correct data
		function correctData (props) {
			if (layerName == 'PercChangePop') {
				return props.PercChangePop;
			}
			if (layerName == 'PercChangeWhitePop') {
				return props.PercChangeWhitePop;
			}
			if (layerName == 'PercChangeBach') {
				return props.PercChangeBach;
			}
			if (layerName == 'PercChangeHomeown') {
				return props.PercChangeHomeown;
			}
			if (layerName == 'PercChangeInc') {
				return props.PercChangeInc;
			}
			if (layerName == 'PercChangeHomeVal') {
				return props.PercChangeHomeVal;
			}
			if (layerName == 'PercChangeMedRent') {
				return props.PercChangeMedRent;
			}
		}

		// Helper dictionary for the update function to get the correct label
		infoLabelDict = {
			'PercChangePop': 'Change in Population',
			'PercChangeWhitePop': 'Change in White Population',
			'PercChangeBach': 'Change in College-Educated Population',
			'PercChangeHomeown': 'Change in Homeowner Rate',
			'PercChangeInc': 'Change in Median Income',
			'PercChangeHomeVal': 'Change in Home Value',
			'PercChangeMedRent': 'Change in Rent'
		};

		// Helper dictionary for update function to get the correct title
		infoTitleDict = {
			'PercChangePop': 'Percent Change in Total Population <br / > by Census Tract 2011-2021',
			'PercChangeWhitePop': 'Percent Change in Non-Hispanic White Population  <br / > by Census Tract 2011-2021',
			'PercChangeBach': 'Percent Change in Population 25 and Older with Bachelor\'s Degrees <br / > by Census Tract 2011-2021',
			'PercChangeHomeown': 'Percent Change in Homeowner Rate <br / > by Census Tract 2011-2021',
			'PercChangeInc': 'Percent Change in Median Household Income <br / > by Census Tract 2011-2021',
			'PercChangeHomeVal': 'Percent Change in Median Home Value <br / > by Census Tract 2011-2021',
			'PercChangeMedRent': 'Percent Change in Median Rent <br / > by Census Tract 2011-2021'
		};

		// Update function of the info box to get the correct title
		info.update = function (props) {
			const contents = props ? `<b>${props.NAMELSAD10}</b><br /> ${infoLabelDict[layerName]}: ${(correctData(props, layerName)*100).toLocaleString("en-US")}%` : 'Hover over a Census Tract';
			this._div.innerHTML = `<h4>${infoTitleDict[layerName]}</h4>${contents}`;
		};


		// Adjust colors of the states
		function getColor(d) {
			if (layerName == 'PercChangePop') {
				return d > 0.3 ? '#99000d' :
				d > 0.25  ? '#cb181d' :
				d > 0.2  ? '#ef3b2c' :
				d > 0.15  ? '#fb6a4a' :
				d > 0.1   ? '#fc9272' :
				d > 0.05   ? '#fcbba1' :
				d > 0   ? '#fee5d9' : 
				d > -100   ? '#eff3ff' : '#d3d3d3';
			}
			if (layerName == 'PercChangeWhitePop') {
				return d > 0.2 ? '#fb6a4a' :
				d > 0.1  ? '#fcae91' :
				d > 0  ? '#fee5d9' :
				d > -0.1  ? '#eff3ff' :
				d > -0.2   ? '#bdd7e7' :
				d > -0.3   ? '#6baed6' :
				d > -0.4   ? '#3182bd' : 
				d > -100   ? '#08519c' : '#d3d3d3';
			}
			if (layerName == 'PercChangeBach') {
				return d > 0.8 ? '#a50f15' :
				d > 0.6  ? '#de2d26' :
				d > 0.4  ? '#fb6a4a' :
				d > 0.2  ? '#fcae91' :
				d > 0   ? '#fee5d9' :
				d > -0.2   ? '#eff3ff' :
				d > -0.4   ? '#bdd7e7' : 
				d > -100   ? '#6baed6': '#d3d3d3';
			}
			if (layerName == 'PercChangeHomeown') {
				return d > 0.2 ? '#fb6a4a' :
				d > 0.1  ? '#fcae91' :
				d > 0  ? '#fee5d9' :
				d > -0.1  ? '#eff3ff' :
				d > -0.2   ? '#bdd7e7' :
				d > -0.3   ? '#6baed6' :
				d > -0.4   ? '#3182bd' : 
				d > -100   ? '#08519c' : '#d3d3d3';
			}
			if (layerName == 'PercChangeInc') {
				return d > 0.6 ? '#99000d' :
				d > 0.5  ? '#cb181d' :
				d > 0.4  ? '#ef3b2c' :
				d > 0.3  ? '#fb6a4a' :
				d > 0.2   ? '#fc9272' :
				d > 0.1   ? '#fcbba1' :
				d > 0   ? '#fee5d9' : 
				d > -100  ? '#eff3ff': '#d3d3d3';
			}
			if (layerName == 'PercChangeHomeVal') {
				return d > 0.3 ? '#cb181d' :
				d > 0.2  ? '#fb6a4a' :
				d > 0.1  ? '#fcae91' :
				d > 0  ? '#fee5d9' :
				d > -0.1   ? '#eff3ff' :
				d > -0.2   ? '#bdd7e7' :
				d > -0.3   ? '#6baed6' : 
				d > -100   ? '#2171b5' : '#d3d3d3';
			}
			if (layerName == 'PercChangeMedRent') {
				return d > 0.6 ? '#99000d' :
				d > 0.5  ? '#cb181d' :
				d > 0.4  ? '#ef3b2c' :
				d > 0.3  ? '#fb6a4a' :
				d > 0.2   ? '#fc9272' :
				d > 0.1   ? '#fcbba1' :
				d > 0   ? '#fee5d9' : 
				d > -100   ? '#eff3ff' : '#d3d3d3';
			}
		}
		
		// Declare variable to keep track of what layer we're looking at
		var layerName = 'PercChangePop';

		// Helper function to get the correct data in the style() function
		function correctStyle(feature) {
			if (layerName == 'PercChangePop') {
				return feature.properties.PercChangePop;
			}
			if (layerName == 'PercChangeWhitePop') {
				return feature.properties.PercChangeWhitePop;
			}
			if (layerName == 'PercChangeBach') {
				return feature.properties.PercChangeBach;
			}
			if (layerName == 'PercChangeHomeown') {
				return feature.properties.PercChangeHomeown;
			}
			if (layerName == 'PercChangeInc') {
				return feature.properties.PercChangeInc;
			}
			if (layerName == 'PercChangeHomeVal') {
				return feature.properties.PercChangeHomeVal;
			}
			if (layerName == 'PercChangeMedRent') {
				return feature.properties.PercChangeMedRent;
			}
		}

		// Styles what the default census tracts look like
		function style(feature) {
			return {
				weight: 2,
				opacity: 1,
				color: 'white',
				dashArray: '3',
				fillOpacity: 0.8,
				fillColor: getColor(correctStyle(feature)) // Uses a helper function to get the correct data
			};
		}

		// How it looks when hovering over it
		function highlightFeature(e) {
			const layer = e.target;

			layer.setStyle({
				weight: 5,
				color: '#666',
				dashArray: '',
				fillOpacity: 0.8
			});

			layer.bringToFront();

			info.update(layer.feature.properties);
		}


        // Add the json layer with the default style and interactive features
		const geojson = L.geoJson(tractsData, {
			style: style,
			onEachFeature: onEachFeature
		})

		
        // Updates properties on the layer when you click the buttons
        function updateProperty(propertyName) {

			// Grab the previous layer name to use to change the color of the buttons
			var prevLayerName = layerName;

			// Update the variable that keeps track of what layer we're on
			layerName = propertyName;

            geojson.eachLayer(function (layer) {

				// Change the color based on the property
				layer.setStyle({
					fillColor: getColor(layer.feature.properties[propertyName])
				});

				// Update the info box
				info.update();
				legend.addTo(map);
            });

			// Update the color of the buttons
			document.getElementById(prevLayerName).classList.remove("selected");
			document.getElementById(propertyName).classList.add("selected");
        }


        // When mousing away from a tract
        function resetHighlight(e) {
			geojson.resetStyle(e.target);
			info.update();
		}

		// Zooms when features are clicked
		function zoomToFeature(e) {
			map.fitBounds(e.target.getBounds());
		}

		// The functionalities the Census tracts have
		function onEachFeature(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlight,
				click: zoomToFeature
			});
		}


		// Add legend
		const legend = L.control({position: 'bottomright'});

		legend.onAdd = function (map) {

			const div = L.DomUtil.create('div', 'info legend');
			const grades = {
				'PercChangePop': [-0.05, 0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3],
				'PercChangeWhitePop': [-0.6, -0.4, -0.3, -0.2, -0.1, 0, 0.1, 0.2],
				'PercChangeBach': [-0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6, 0.8],
				'PercChangeHomeown': [-0.5, -0.4, -0.3, -0.2, -0.1, 0, 0.1, 0.2],
				'PercChangeInc': [-0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6],
				'PercChangeHomeVal': [-0.4, -0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3],
				'PercChangeMedRent': [-0.1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6]
			}
			const labels = [];
			let from, to;

			for (let i = 0; i < grades[layerName].length; i++) {
				from = grades[layerName][i];
				to = grades[layerName][i + 1];

				// TODO - EDIT TO SAY ___ DECREASE AND ___ INCREASE
				if (i == 0) {
					labels.push(`<i style="background:${getColor(from + .01)}"></i> Less than ${(to*100).toLocaleString("en-US")}%`);
				}

				else if (i == grades[layerName].length - 1) {
					labels.push(`<i style="background:${getColor(from + .01)}"></i> Greater than ${(from*100).toLocaleString("en-US")}%`);
				}

				else {
					labels.push(`<i style="background:${getColor(from + .01)}"></i> ${(from*100).toLocaleString("en-US")}% &ndash; ${(to*100).toLocaleString("en-US")}%`);
				}

				// labels.push(`<i style="background:${getColor(from + .01)}"></i> ${(from*100).toLocaleString("en-US")}% ${to ? `&ndash; ${(to*100).toLocaleString("en-US")}%` : '+'}`);
			}

			labels.push(`<i style="background: #d3d3d3"></i> NaN`);

			div.innerHTML = labels.join('<br>');
			return div;
		};


        // Add everything to the map
        info.addTo(map);
		geojson.addTo(map);
		legend.addTo(map);


	</script>
</body>
</html>